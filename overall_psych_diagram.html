<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Psychological Components — Interconnection Map</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Playfair+Display:ital,wght@0,700;0,900;1,400&family=DM+Sans:wght@300;400;500&display=swap');

  :root {
    --bg: #06080f;
    --emotion:    #e8425a;
    --feeling:    #f4a261;
    --intention:  #a8dadc;
    --behaviour:  #6bcb77;
    --cognition:  #c77dff;
    --trigger:    #ffd166;
    --need:       #ff9ef5;
    --text: #dde1ec;
    --muted: #3d4560;
    --surface: rgba(12,16,30,0.95);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    overflow: hidden;
    width: 100vw; height: 100vh;
  }

  /* Top bar */
  #topbar {
    position: fixed; top:0; left:0; right:0;
    height: 56px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 28px;
    background: rgba(6,8,15,0.9);
    backdrop-filter: blur(14px);
    border-bottom: 1px solid rgba(255,255,255,0.06);
    z-index: 100;
  }

  #topbar h1 {
    font-family: 'Playfair Display', serif;
    font-size: 17px;
    font-weight: 700;
    letter-spacing: 0.02em;
    color: #fff;
  }

  #topbar p {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  /* Filter tabs */
  #filters {
    position: fixed;
    top: 68px; left: 50%;
    transform: translateX(-50%);
    display: flex; gap: 8px;
    z-index: 100;
    background: rgba(6,8,15,0.7);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 40px;
    padding: 6px 8px;
  }

  .ftab {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 6px 16px;
    border-radius: 30px;
    cursor: pointer;
    border: none;
    background: transparent;
    color: var(--muted);
    transition: all 0.2s;
  }

  .ftab:hover { color: #fff; }
  .ftab.active { color: #000; }

  /* Legend */
  #legend {
    position: fixed;
    bottom: 20px; left: 20px;
    background: var(--surface);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 14px;
    padding: 18px 22px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    min-width: 190px;
  }

  #legend h3 {
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 14px;
  }

  .li { display:flex; align-items:center; gap:10px; margin-bottom:9px; font-size:10px; }
  .ld { width:10px; height:10px; border-radius:50%; flex-shrink:0; }

  /* Tooltip */
  #tip {
    position: fixed;
    pointer-events: none;
    background: var(--surface);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 16px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    max-width: 260px;
    opacity: 0;
    transition: opacity 0.18s;
    z-index: 300;
  }

  #tip .tn { font-family:'Playfair Display',serif; font-size:15px; font-weight:700; color:#fff; margin-bottom:8px; }
  #tip .tc { font-size:9px; letter-spacing:0.1em; text-transform:uppercase; margin-bottom:10px; }
  #tip .td { color:#8892aa; font-size:10px; line-height:1.7; }
  #tip .tw { margin-top:10px; display:flex; gap:6px; flex-wrap:wrap; }
  #tip .twb {
    font-size:9px; padding:3px 8px; border-radius:20px;
    background: rgba(255,255,255,0.06);
    color: #aab;
    border: 1px solid rgba(255,255,255,0.08);
  }

  /* Flow legend */
  #flowleg {
    position: fixed;
    bottom: 20px; right: 20px;
    background: var(--surface);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 14px;
    padding: 18px 22px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
  }
  #flowleg h3 {
    font-size:10px; font-weight:500;
    letter-spacing:0.12em; text-transform:uppercase;
    color:var(--muted); margin-bottom:12px;
    font-family:'DM Sans',sans-serif;
  }
  .fl { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
  .fl-line { width:30px; height:2px; }

  #hint {
    position: fixed; top: 68px; right: 20px;
    font-family: 'DM Mono', monospace;
    font-size: 9px; color: var(--muted);
    text-align:right; line-height:2;
    letter-spacing:0.05em;
  }

  canvas { display:block; }
</style>
</head>
<body>

<div id="topbar">
  <h1>Psychological Components — Interconnection Map</h1>
  <p>Emotions · Feelings · Intentions · Behaviours · Cognitions</p>
</div>

<div id="filters">
  <button class="ftab active" data-filter="all" style="background:#fff">ALL</button>
  <button class="ftab" data-filter="emotion"   style="--c:#e8425a">EMOTIONS</button>
  <button class="ftab" data-filter="feeling"   style="--c:#f4a261">FEELINGS</button>
  <button class="ftab" data-filter="intention" style="--c:#a8dadc">INTENTIONS</button>
  <button class="ftab" data-filter="behaviour" style="--c:#6bcb77">BEHAVIOURS</button>
  <button class="ftab" data-filter="cognition" style="--c:#c77dff">COGNITIONS</button>
  <button class="ftab" data-filter="need"      style="--c:#ff9ef5">NEEDS</button>
</div>

<div id="legend">
  <h3>Component Types</h3>
  <div class="li"><div class="ld" style="background:#e8425a"></div>Raw Emotion</div>
  <div class="li"><div class="ld" style="background:#f4a261"></div>Felt Feeling</div>
  <div class="li"><div class="ld" style="background:#a8dadc"></div>Intention</div>
  <div class="li"><div class="ld" style="background:#6bcb77"></div>Behaviour</div>
  <div class="li"><div class="ld" style="background:#c77dff"></div>Cognition / Belief</div>
  <div class="li"><div class="ld" style="background:#ffd166"></div>Trigger / Event</div>
  <div class="li"><div class="ld" style="background:#ff9ef5"></div>Underlying Need</div>
</div>

<div id="flowleg">
  <h3>Edge Types</h3>
  <div class="fl"><div class="fl-line" style="background:#a8dadc"></div>Generates / Causes</div>
  <div class="fl"><div class="fl-line" style="background:#ff4757; height:2px; background: repeating-linear-gradient(90deg,#ff4757 0,#ff4757 6px,transparent 6px,transparent 10px)"></div>Suppresses / Conflicts</div>
  <div class="fl"><div class="fl-line" style="background:#ffd166"></div>Amplifies</div>
  <div class="fl"><div class="fl-line" style="background:#6bcb77"></div>Reinforces</div>
</div>

<div id="hint">DRAG · SCROLL to zoom<br>HOVER for detail<br>CLICK tab to filter</div>

<div id="tip">
  <div class="tn" id="tn"></div>
  <div class="tc" id="tc"></div>
  <div class="td" id="td"></div>
  <div class="tw" id="tw"></div>
</div>

<canvas id="c"></canvas>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H;

function resize() {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

const C = {
  emotion:   '#e8425a',
  feeling:   '#f4a261',
  intention: '#a8dadc',
  behaviour: '#6bcb77',
  cognition: '#c77dff',
  trigger:   '#ffd166',
  need:      '#ff9ef5',
};

// ── NODES ──────────────────────────────────────────────
const nodes = [
  // TRIGGERS
  { id:0,  label:'External Event',    type:'trigger',   r:22, sig:0.9,
    desc:'An outside stimulus — a message, a rejection, a success, a person. The raw input before any internal processing begins.',
    connects:['Emotion','Perception','Appraisal'] },
  { id:1,  label:'Memory / Past',     type:'trigger',   r:18, sig:0.75,
    desc:'Internally triggered by recalling a past experience. Memory re-activates the emotional signature of the original event.',
    connects:['Fear','Grief','Nostalgia','Appraisal'] },

  // NEEDS
  { id:2,  label:'Need for Safety',   type:'need', r:20, sig:0.88,
    desc:'Fundamental psychological need (Maslow). Unmet → anxiety and fear responses. Met → openness and exploration.',
    connects:['Fear','Anxiety','Avoidance'] },
  { id:3,  label:'Need for Connection', type:'need', r:20, sig:0.85,
    desc:'Drives attachment-seeking behaviour. Unmet → loneliness, jealousy, rejection sensitivity. Met → warmth and belonging.',
    connects:['Love','Loneliness','Jealousy','Seek Closeness'] },
  { id:4,  label:'Need for Autonomy',   type:'need', r:18, sig:0.80,
    desc:'Need to feel in control of one\'s own life. Unmet → resentment and rebellion. Met → motivation and agency.',
    connects:['Anger','Resentment','Intention to Act','Assertive Behaviour'] },
  { id:5,  label:'Need for Esteem',     type:'need', r:18, sig:0.78,
    desc:'Need to feel worthy, capable, respected. Unmet → shame, envy. Met → confidence and ambition.',
    connects:['Shame','Pride','Envy','Ambition'] },

  // RAW EMOTIONS
  { id:6,  label:'Fear',       type:'emotion', r:22, sig:0.92,
    desc:'Primary emotion. Triggered by perceived threat. Activates the amygdala before conscious processing. Pure physiological signal.',
    connects:['Anxiety','Avoidance','Freeze','Hypervigilance'] },
  { id:7,  label:'Anger',      type:'emotion', r:22, sig:0.90,
    desc:'Primary emotion. Activated when goals are blocked or autonomy violated. High energy, approach-oriented activation.',
    connects:['Resentment','Aggression','Assertive Behaviour','Rumination'] },
  { id:8,  label:'Sadness',    type:'emotion', r:20, sig:0.85,
    desc:'Primary emotion. Loss signal. Slows the system down to allow integration and meaning-making.',
    connects:['Grief','Loneliness','Withdrawal','Reflection'] },
  { id:9,  label:'Joy',        type:'emotion', r:20, sig:0.82,
    desc:'Primary emotion. Reward signal. Broadens thinking and encourages approach behaviour.',
    connects:['Excitement','Love','Openness','Seek Closeness'] },
  { id:10, label:'Disgust',    type:'emotion', r:16, sig:0.70,
    desc:'Primary emotion. Rejection signal for contaminants — physical or moral. Drives avoidance and moral judgment.',
    connects:['Contempt','Avoidance','Moral Belief'] },
  { id:11, label:'Shame',      type:'emotion', r:20, sig:0.87,
    desc:'Self-directed negative evaluation. "I am bad." Different from guilt which is "I did bad." Highly corrosive to identity.',
    connects:['Withdrawal','Self-Criticism','Avoidance','Hiding Behaviour'] },
  { id:12, label:'Envy',       type:'emotion', r:16, sig:0.72,
    desc:'Wanting what another has. Complex social emotion — can motivate ambition or generate hostility depending on appraisal.',
    connects:['Resentment','Ambition','Comparison Thinking'] },

  // FELT FEELINGS (subjective, named, conscious layer)
  { id:13, label:'Anxiety',      type:'feeling', r:22, sig:0.91,
    desc:'Fear extended into future uncertainty. Unlike fear it has no specific object. Chronic anxiety suppresses intention formation.',
    connects:['Avoidance','Overthinking','Hypervigilance','Procrastination'] },
  { id:14, label:'Excitement',   type:'feeling', r:18, sig:0.78,
    desc:'Joy + anticipation of a future positive. Shares the same physiological signature as anxiety — cognitive appraisal distinguishes them.',
    connects:['Intention to Act','Risk Taking','Openness'] },
  { id:15, label:'Loneliness',   type:'feeling', r:18, sig:0.80,
    desc:'Felt disconnection. Motivates social approach OR triggers social withdrawal depending on past experience.',
    connects:['Seek Closeness','Withdrawal','Rumination'] },
  { id:16, label:'Grief',        type:'feeling', r:18, sig:0.82,
    desc:'Sustained sadness following loss. Requires integration time. Inhibits most future-oriented intentions temporarily.',
    connects:['Reflection','Withdrawal','Meaning Making'] },
  { id:17, label:'Resentment',   type:'feeling', r:18, sig:0.76,
    desc:'Anger that has been repeatedly suppressed. Builds over time. Poisons relationships without visible cause.',
    connects:['Passive Aggression','Withdrawal','Rumination'] },
  { id:18, label:'Pride',        type:'feeling', r:16, sig:0.74,
    desc:'Positive self-evaluation after success. Reinforces identity and future ambitious behaviour when healthy.',
    connects:['Ambition','Confidence Belief','Assertive Behaviour'] },
  { id:19, label:'Nostalgia',    type:'feeling', r:14, sig:0.60,
    desc:'Bittersweet feeling about the past. Can reinforce identity continuity or trigger grief.',
    connects:['Reflection','Meaning Making','Grief'] },
  { id:20, label:'Contempt',     type:'feeling', r:14, sig:0.65,
    desc:'Feeling of superiority over another. A relationship-destroying signal. Often masks deep insecurity.',
    connects:['Avoidance','Withdrawal','Passive Aggression'] },

  // COGNITIONS / BELIEFS
  { id:21, label:'Appraisal',         type:'cognition', r:22, sig:0.93,
    desc:'The brain\'s evaluation of what an event MEANS to the self. Central to all emotion regulation. Same event → different appraisal → different emotion.',
    connects:['Anxiety','Excitement','Anger','Joy','Shame'] },
  { id:22, label:'Rumination',        type:'cognition', r:18, sig:0.80,
    desc:'Repetitive negative thinking. Amplifies sadness and anger. A cognitive trap — feels like problem-solving but isn\'t.',
    connects:['Anxiety','Resentment','Procrastination','Withdrawal'] },
  { id:23, label:'Comparison Thinking',type:'cognition',r:16, sig:0.72,
    desc:'Evaluating self relative to others. Drives envy, shame, or pride depending on result direction.',
    connects:['Envy','Shame','Pride','Ambition'] },
  { id:24, label:'Overthinking',      type:'cognition', r:16, sig:0.74,
    desc:'Excessive analysis of options without resolution. Generates anxiety and suppresses decisive intention.',
    connects:['Anxiety','Procrastination','Paralysis'] },
  { id:25, label:'Confidence Belief', type:'cognition', r:16, sig:0.76,
    desc:'"I am capable." Core self-efficacy belief. Enables risk-taking and approach behaviour. Damaged by shame and failure.',
    connects:['Intention to Act','Risk Taking','Assertive Behaviour'] },
  { id:26, label:'Moral Belief',      type:'cognition', r:14, sig:0.65,
    desc:'Internalized values about right and wrong. Shapes which intentions are acted upon and which are suppressed.',
    connects:['Intention to Act','Avoidance','Assertive Behaviour'] },
  { id:27, label:'Meaning Making',    type:'cognition', r:18, sig:0.82,
    desc:'The process of integrating difficult experiences into a coherent life narrative. Critical for post-trauma growth.',
    connects:['Openness','Intention to Act','Ambition'] },

  // INTENTIONS
  { id:28, label:'Intention to Act',  type:'intention', r:24, sig:0.95,
    desc:'The bridge between internal state and external behaviour. Formed when emotion + belief + need align toward a goal.',
    connects:['Assertive Behaviour','Risk Taking','Seek Closeness','Approach Behaviour'] },
  { id:29, label:'Intention to Avoid',type:'intention', r:20, sig:0.85,
    desc:'Formed under fear, shame, or anxiety. Protective short-term, but suppresses growth when chronic.',
    connects:['Avoidance','Procrastination','Hiding Behaviour','Withdrawal'] },
  { id:30, label:'Ambition',          type:'intention', r:20, sig:0.88,
    desc:'Future-directed intention formed by pride, envy, and unmet esteem needs. High energy, approach-oriented.',
    connects:['Risk Taking','Assertive Behaviour','Approach Behaviour'] },
  { id:31, label:'Hypervigilance',    type:'intention', r:16, sig:0.72,
    desc:'Constant threat-scanning mode. Formed by chronic fear or trauma. Exhausts cognitive resources.',
    connects:['Avoidance','Rumination','Anxiety'] },

  // BEHAVIOURS
  { id:32, label:'Approach Behaviour',   type:'behaviour', r:22, sig:0.90,
    desc:'Moving toward goals, people, or experiences. Driven by joy, excitement, confidence, and approach intentions.',
    connects:['Seek Closeness','Risk Taking','Assertive Behaviour'] },
  { id:33, label:'Avoidance',            type:'behaviour', r:22, sig:0.88,
    desc:'Moving away from threat or discomfort. Provides short-term relief but prevents exposure and growth. A central target in therapy.',
    connects:['Procrastination','Withdrawal','Hiding Behaviour'] },
  { id:34, label:'Assertive Behaviour',  type:'behaviour', r:18, sig:0.80,
    desc:'Expressing needs and boundaries directly. Requires confidence belief + anger regulation + autonomy need fulfillment.',
    connects:['Approach Behaviour'] },
  { id:35, label:'Withdrawal',           type:'behaviour', r:18, sig:0.78,
    desc:'Social or emotional disengagement. Serves a protective function but reinforces loneliness and shame when chronic.',
    connects:['Loneliness','Rumination'] },
  { id:36, label:'Risk Taking',          type:'behaviour', r:18, sig:0.76,
    desc:'Approach behaviour under uncertainty. Requires excitement + confidence belief + tolerance of anxiety.',
    connects:['Approach Behaviour'] },
  { id:37, label:'Procrastination',      type:'behaviour', r:18, sig:0.82,
    desc:'Avoidance of a task associated with anxiety or self-doubt. NOT laziness — it\'s an emotion regulation strategy.',
    connects:['Anxiety','Avoidance'] },
  { id:38, label:'Seek Closeness',       type:'behaviour', r:16, sig:0.74,
    desc:'Behaviour driven by connection need. Can be anxious (clinging) or secure depending on internal state.',
    connects:['Approach Behaviour'] },
  { id:39, label:'Hiding Behaviour',     type:'behaviour', r:14, sig:0.65,
    desc:'Concealing feelings, identity, or mistakes. Driven by shame. Reinforces the shame cycle.',
    connects:['Withdrawal','Shame'] },
  { id:40, label:'Passive Aggression',   type:'behaviour', r:14, sig:0.68,
    desc:'Indirect expression of anger. Formed when direct assertion feels unsafe. Erodes trust over time.',
    connects:['Withdrawal','Resentment'] },
  { id:41, label:'Reflection',           type:'behaviour', r:16, sig:0.70,
    desc:'Intentional self-examination. Converts raw experience into insight. The beginning of meaning making.',
    connects:['Meaning Making','Appraisal'] },
  { id:42, label:'Openness',             type:'behaviour', r:16, sig:0.72,
    desc:'Receptivity to new experience. Enabled by safety, joy, and trust. Blocked by fear and shame.',
    connects:['Approach Behaviour','Seek Closeness'] },
];

// ── EDGES ──────────────────────────────────────────────
// [from_id, to_id, weight, type]
// types: 'causes' | 'suppresses' | 'amplifies' | 'reinforces'
const edges = [
  // Triggers → Emotions
  [0, 21, 0.95, 'causes'],
  [1, 21, 0.80, 'causes'],
  [1, 16, 0.70, 'causes'],

  // Needs → Emotions
  [2, 6,  0.88, 'causes'],
  [3, 9,  0.80, 'causes'],
  [3, 15, 0.75, 'causes'],
  [4, 7,  0.85, 'causes'],
  [5, 11, 0.82, 'causes'],
  [5, 12, 0.70, 'causes'],
  [5, 18, 0.72, 'causes'],

  // Appraisal → Feelings
  [21, 13, 0.88, 'causes'],
  [21, 14, 0.80, 'causes'],
  [21, 7,  0.78, 'causes'],
  [21, 11, 0.72, 'causes'],

  // Emotion → Feeling
  [6,  13, 0.90, 'causes'],
  [7,  17, 0.85, 'causes'],
  [8,  16, 0.88, 'causes'],
  [9,  14, 0.85, 'causes'],
  [10, 20, 0.80, 'causes'],
  [11, 17, 0.70, 'causes'],
  [12, 17, 0.72, 'causes'],

  // Feelings → Cognition
  [13, 22, 0.85, 'amplifies'],
  [13, 24, 0.80, 'causes'],
  [17, 22, 0.82, 'amplifies'],
  [15, 22, 0.70, 'amplifies'],
  [18, 25, 0.78, 'reinforces'],
  [16, 27, 0.82, 'causes'],
  [19, 27, 0.65, 'causes'],

  // Cognition → Intention
  [21, 28, 0.90, 'causes'],
  [22, 29, 0.85, 'causes'],
  [24, 29, 0.80, 'causes'],
  [25, 28, 0.88, 'reinforces'],
  [25, 30, 0.82, 'causes'],
  [26, 28, 0.70, 'causes'],
  [26, 29, 0.65, 'causes'],
  [27, 28, 0.78, 'causes'],
  [23, 30, 0.72, 'causes'],
  [12, 30, 0.68, 'causes'],

  // Feelings → Intention
  [13, 29, 0.85, 'causes'],
  [14, 28, 0.88, 'causes'],
  [15, 28, 0.65, 'causes'],
  [6,  31, 0.82, 'causes'],

  // Intention → Behaviour
  [28, 32, 0.92, 'causes'],
  [28, 34, 0.85, 'causes'],
  [28, 36, 0.78, 'causes'],
  [28, 38, 0.72, 'causes'],
  [29, 33, 0.90, 'causes'],
  [29, 37, 0.85, 'causes'],
  [29, 39, 0.72, 'causes'],
  [30, 36, 0.82, 'causes'],
  [30, 32, 0.78, 'causes'],
  [31, 33, 0.80, 'causes'],

  // Behaviour → reinforces / feedback loops
  [33, 13, 0.80, 'reinforces'],  // avoidance → more anxiety
  [37, 13, 0.75, 'reinforces'],  // procrastination → anxiety
  [35, 15, 0.78, 'reinforces'],  // withdrawal → loneliness
  [39, 11, 0.82, 'reinforces'],  // hiding → shame (loop)
  [40, 17, 0.70, 'reinforces'],  // passive aggression → resentment
  [32, 14, 0.72, 'reinforces'],  // approach → excitement
  [41, 27, 0.85, 'causes'],      // reflection → meaning making
  [42, 28, 0.75, 'reinforces'],  // openness → intention

  // Suppression edges
  [13, 28, 0.80, 'suppresses'],  // anxiety suppresses intention to act
  [11, 25, 0.85, 'suppresses'],  // shame suppresses confidence
  [22, 28, 0.72, 'suppresses'],  // rumination suppresses action
  [16, 28, 0.70, 'suppresses'],  // grief suppresses intention
];

// Physics layout
const rng = (a, b) => a + Math.random() * (b - a);
nodes.forEach((n, i) => {
  const a = (i / nodes.length) * Math.PI * 2 + rng(-0.3, 0.3);
  const radius = rng(180, 320);
  n.x = rng(-60, 60) + Math.cos(a) * radius;
  n.y = rng(-60, 60) + Math.sin(a) * radius;
  n.vx = 0; n.vy = 0;
  n.color = C[n.type];
});

// Pan/zoom
let panX = 0, panY = 0, scale = 0.85;
let isPan = false, lmx = 0, lmy = 0;
let activeFilter = 'all';
let hovered = null;
let frame = 0;

// Filter buttons
document.querySelectorAll('.ftab').forEach(btn => {
  btn.addEventListener('click', () => {
    activeFilter = btn.dataset.filter;
    document.querySelectorAll('.ftab').forEach(b => {
      b.classList.remove('active');
      b.style.background = 'transparent';
      b.style.color = '';
    });
    btn.classList.add('active');
    btn.style.background = '#fff';
    btn.style.color = '#000';
  });
});

canvas.addEventListener('mousedown', e => { isPan=true; lmx=e.clientX; lmy=e.clientY; });
canvas.addEventListener('mousemove', e => {
  if (isPan) { panX += e.clientX-lmx; panY += e.clientY-lmy; lmx=e.clientX; lmy=e.clientY; }
  handleHover(e);
});
canvas.addEventListener('mouseup', () => isPan=false);
canvas.addEventListener('mouseleave', () => { isPan=false; document.getElementById('tip').style.opacity=0; });
canvas.addEventListener('wheel', e => {
  e.preventDefault();
  scale = Math.max(0.2, Math.min(3, scale * (e.deltaY>0 ? 0.91 : 1.09)));
}, {passive:false});

function toWorld(mx, my) {
  return { x:(mx-W/2-panX)/scale, y:(my-H/2-panY)/scale };
}

function handleHover(e) {
  const w = toWorld(e.clientX, e.clientY);
  hovered = null;
  for (let n of nodes) {
    if (activeFilter !== 'all' && n.type !== activeFilter) continue;
    const dx=n.x-w.x, dy=n.y-w.y;
    if (Math.sqrt(dx*dx+dy*dy) < n.r+6) { hovered=n; break; }
  }
  const tip = document.getElementById('tip');
  if (hovered) {
    document.getElementById('tn').textContent = hovered.label;
    document.getElementById('tc').style.color = hovered.color;
    document.getElementById('tc').textContent = hovered.type.toUpperCase();
    document.getElementById('td').textContent = hovered.desc;
    const tw = document.getElementById('tw');
    tw.innerHTML = hovered.connects.map(c => `<span class="twb">→ ${c}</span>`).join('');
    tip.style.left = (e.clientX+18)+'px';
    tip.style.top  = (e.clientY-20)+'px';
    tip.style.opacity = 1;
  } else { tip.style.opacity = 0; }
}

// Force sim
function sim() {
  const rep = 11000, k = 260, damp = 0.82;
  nodes.forEach(n => { n.vx=0; n.vy=0; });

  for (let i=0;i<nodes.length;i++) for (let j=i+1;j<nodes.length;j++) {
    const a=nodes[i],b=nodes[j];
    let dx=b.x-a.x, dy=b.y-a.y;
    const d=Math.sqrt(dx*dx+dy*dy)||1;
    const f=rep/(d*d);
    const fx=(dx/d)*f, fy=(dy/d)*f;
    a.vx-=fx; a.vy-=fy; b.vx+=fx; b.vy+=fy;
  }

  edges.forEach(([si,ti,w]) => {
    const a=nodes[si],b=nodes[ti];
    const dx=b.x-a.x,dy=b.y-a.y;
    const d=Math.sqrt(dx*dx+dy*dy)||1;
    const ideal=k*(1.3-w*0.5);
    const f=(d-ideal)*0.035;
    const fx=(dx/d)*f,fy=(dy/d)*f;
    a.vx+=fx; a.vy+=fy; b.vx-=fx; b.vy-=fy;
  });

  nodes.forEach(n => {
    n.vx+=(0-n.x)*0.006; n.vy+=(0-n.y)*0.006;
    n.x+=n.vx*damp; n.y+=n.vy*damp;
  });
}

// Edge type styles
const edgeStyle = {
  causes:     { color: (a)=>`rgba(168,218,220,${a})`,   dash: [],     },
  amplifies:  { color: (a)=>`rgba(255,209,102,${a})`,   dash: [],     },
  reinforces: { color: (a)=>`rgba(107,203,119,${a})`,   dash: [],     },
  suppresses: { color: (a)=>`rgba(255,71,87,${a})`,     dash: [5,4],  },
};

function drawArrow(x1,y1,x2,y2,color,lw) {
  const angle = Math.atan2(y2-y1,x2-x1);
  const len = 7;
  ctx.save();
  ctx.strokeStyle = color;
  ctx.fillStyle = color;
  ctx.lineWidth = lw;
  ctx.beginPath();
  ctx.moveTo(x2, y2);
  ctx.lineTo(x2 - len*Math.cos(angle-0.4), y2 - len*Math.sin(angle-0.4));
  ctx.lineTo(x2 - len*Math.cos(angle+0.4), y2 - len*Math.sin(angle+0.4));
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

function draw() {
  requestAnimationFrame(draw);
  frame++;

  ctx.clearRect(0,0,W,H);

  // Subtle radial bg
  const bg = ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,Math.max(W,H)*0.7);
  bg.addColorStop(0,'#0a0f1e');
  bg.addColorStop(1,'#06080f');
  ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);

  // Fine grid
  ctx.strokeStyle='rgba(255,255,255,0.025)'; ctx.lineWidth=1;
  const gs=50;
  for(let x=(W/2+panX)%gs;x<W;x+=gs){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=(H/2+panY)%gs;y<H;y+=gs){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}

  ctx.save();
  ctx.translate(W/2+panX, H/2+panY);
  ctx.scale(scale,scale);

  // Visible nodes for filter
  const visible = activeFilter==='all' ? nodes : nodes.filter(n=>n.type===activeFilter);
  const visIds = new Set(visible.map(n=>n.id));

  // Edges
  edges.forEach(([si,ti,w,type]) => {
    const a=nodes[si], b=nodes[ti];
    const bothVis = visIds.has(si) && visIds.has(ti);
    if (!bothVis) return;

    const isH = hovered && (hovered.id===si||hovered.id===ti);
    const style = edgeStyle[type] || edgeStyle.causes;
    const alpha = isH ? 0.9 : (activeFilter==='all' ? 0.18+w*0.22 : 0.35+w*0.35);
    const lw = isH ? 2+w*3 : 0.8+w*2;

    ctx.save();
    ctx.strokeStyle = style.color(alpha);
    ctx.lineWidth = lw;
    ctx.setLineDash(style.dash);

    // Curve
    const mx=(a.x+b.x)/2+(b.y-a.y)*0.18;
    const my=(a.y+b.y)/2-(b.x-a.x)*0.18;
    ctx.beginPath();
    ctx.moveTo(a.x,a.y);
    ctx.quadraticCurveTo(mx,my,b.x,b.y);
    ctx.stroke();
    ctx.setLineDash([]);

    // Arrow at endpoint
    if (isH) {
      const t=0.85;
      const ex=Math.pow(1-t,2)*a.x+2*(1-t)*t*mx+Math.pow(t,2)*b.x;
      const ey=Math.pow(1-t,2)*a.y+2*(1-t)*t*my+Math.pow(t,2)*b.y;
      drawArrow(a.x,a.y,ex,ey, style.color(0.95), lw);
    }

    ctx.restore();
  });

  // Nodes
  visible.forEach(n => {
    const isH = hovered && hovered.id===n.id;
    const pulse = 0.92 + Math.sin(frame*0.035+n.id*1.1)*0.08;
    const r = n.r * (isH?1.22:1);

    // outer glow
    const glow = ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,r*3);
    glow.addColorStop(0, n.color+'44');
    glow.addColorStop(1, 'transparent');
    ctx.fillStyle=glow;
    ctx.beginPath(); ctx.arc(n.x,n.y,r*3*pulse,0,Math.PI*2); ctx.fill();

    // significance ring arc
    ctx.beginPath();
    ctx.arc(n.x,n.y,r+5,-Math.PI/2,-Math.PI/2+Math.PI*2*n.sig);
    ctx.strokeStyle=n.color;
    ctx.lineWidth=2.5;
    ctx.stroke();

    // body gradient
    const g=ctx.createRadialGradient(n.x-r*0.35,n.y-r*0.35,0,n.x,n.y,r);
    g.addColorStop(0,n.color+'ee');
    g.addColorStop(1,n.color+'77');
    ctx.beginPath(); ctx.arc(n.x,n.y,r,0,Math.PI*2);
    ctx.fillStyle=g; ctx.fill();
    ctx.strokeStyle=isH?'#fff':n.color+'cc';
    ctx.lineWidth=isH?2:1;
    ctx.stroke();

    // label
    ctx.fillStyle=isH?'#fff':'rgba(255,255,255,0.9)';
    const fsize = n.r > 20 ? 11 : 9;
    ctx.font=`${isH?'500':'400'} ${fsize}px DM Sans, sans-serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    const words=n.label.split(' ');
    if(words.length>2){
      const h=Math.ceil(words.length/2);
      ctx.fillText(words.slice(0,h).join(' '),n.x,n.y-6);
      ctx.fillText(words.slice(h).join(' '),n.x,n.y+7);
    } else {
      ctx.fillText(n.label,n.x,n.y);
    }

    // sig badge
    ctx.fillStyle='rgba(255,255,255,0.35)';
    ctx.font=`300 8px DM Mono, monospace`;
    ctx.fillText((n.sig*100).toFixed(0)+'%',n.x,n.y+r+12);
  });

  ctx.restore();

  if(frame<200) sim();
}

// Pre-run sim
for(let i=0;i<150;i++) sim();
draw();
</script>
</body>
</html>